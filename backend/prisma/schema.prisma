// Prisma Schema for Starlight Network Monitor
// This schema defines the database structure for network topology and probe status

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Node types for the network
enum NodeType {
  PROBE         // Physical probe device (Arduino, ESP32, etc.)
  ROUTER        // Network router
  SWITCH        // Network switch
  SERVER        // Server or computer
  GATEWAY       // Internet gateway
  ACCESS_POINT  // Wireless access point
  FIREWALL      // Network firewall
  VIRTUAL       // Virtual/logical grouping node
  INTERNET      // External internet connection (ISP, WAN link)
  MAIN_LINK     // Main network entry point / aggregation point
}

// Monitoring method for each node
enum MonitoringMethod {
  MQTT    // Push updates from device (probes only)
  PING    // ICMP ping polling
  SNMP    // SNMP polling
  HTTP    // HTTP endpoint health check
  NONE    // Visual-only node (no monitoring)
}

// Status of a node or probe
enum Status {
  ONLINE
  OFFLINE
  DEGRADED
  UNKNOWN
}

// Node group - visual grouping zone for organizing nodes
model NodeGroup {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  // Position and size on the canvas
  positionX   Float    @default(0)
  positionY   Float    @default(0)
  width       Float    @default(300)
  height      Float    @default(200)
  
  // Visual customization
  color       String   @default("#3b82f6")  // Blue default
  opacity     Float    @default(0.15)
  
  // Ordering (lower = rendered first/behind)
  zIndex      Int      @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  nodes                 Node[]
  outgoingConnections   GroupConnection[] @relation("SourceGroup")
  incomingConnections   GroupConnection[] @relation("TargetGroup")
  
  @@index([zIndex])
}

// Connection between groups (represents inter-area/department links)
model GroupConnection {
  id             String    @id @default(uuid())
  
  sourceGroupId  String
  targetGroupId  String
  
  sourceGroup    NodeGroup @relation("SourceGroup", fields: [sourceGroupId], references: [id], onDelete: Cascade)
  targetGroup    NodeGroup @relation("TargetGroup", fields: [targetGroupId], references: [id], onDelete: Cascade)
  
  // Connection metadata
  label          String?
  bandwidth      String?   // e.g., "10Gbps", "1Gbps"
  
  // Visual properties
  color          String    @default("#6B7280")
  animated       Boolean   @default(true)
  
  // Timestamps
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  @@unique([sourceGroupId, targetGroupId])
  @@index([sourceGroupId])
  @@index([targetGroupId])
}

// Network node - represents a device or location in the network
model Node {
  id          String   @id @default(uuid())
  name        String
  type        NodeType @default(PROBE)
  description String?
  
  // Group assignment
  groupId     String?
  group       NodeGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  // Position on the canvas
  positionX   Float    @default(0)
  positionY   Float    @default(0)
  
  // Monitoring configuration
  monitoringMethod  MonitoringMethod @default(NONE)
  ipAddress         String?
  pingInterval      Int     @default(30)  // seconds between checks
  
  // MQTT configuration (for PROBE type)
  mqttTopic   String?  @unique
  
  // SNMP configuration
  snmpCommunity     String?
  snmpVersion       String  @default("2c")
  
  // HTTP health check configuration
  httpEndpoint      String?
  httpExpectedCode  Int     @default(200)
  
  // Current status
  status      Status   @default(UNKNOWN)
  lastSeen    DateTime?
  
  // Network connectivity metrics
  latency     Int?     // in milliseconds
  
  // Internet connectivity (separate from local network)
  internetStatus    Status   @default(UNKNOWN)
  internetLastCheck DateTime?
  checkInternetAccess Boolean @default(false)  // Enable internet access checking for this node
  
  // ISP configuration (for INTERNET type nodes)
  ispName           String?   // Expected ISP name to match (e.g., "Comcast", "AT&T")
  ispOrganization   String?   // Alternative organization name to match
  
  // Visual customization
  color       String   @default("#4F46E5")
  icon        String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  outgoingConnections Connection[] @relation("SourceNode")
  incomingConnections Connection[] @relation("TargetNode")
  statusHistory       ProbeStatus[]
  
  @@index([status])
  @@index([mqttTopic])
  @@index([monitoringMethod])
  @@index([ipAddress])
  @@index([groupId])
}

// Connection between nodes
model Connection {
  id           String   @id @default(uuid())
  
  sourceNodeId String
  targetNodeId String
  
  sourceNode   Node     @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode   Node     @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)
  
  // Connection metadata
  label        String?
  bandwidth    String?  // e.g., "1Gbps", "100Mbps"
  
  // Internet source tracking (for connections from INTERNET nodes)
  isActiveSource  Boolean  @default(false)  // Is this the active internet source?
  
  // Visual properties
  color        String   @default("#6B7280")
  animated     Boolean  @default(true)
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([sourceNodeId, targetNodeId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
}

// Historical probe status for analytics
model ProbeStatus {
  id        String   @id @default(uuid())
  
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  status    Status
  latency   Int?     // in milliseconds
  
  // Internet status at this point in time
  internetStatus Status?
  
  // Additional metadata
  message   String?
  
  timestamp DateTime @default(now())
  
  @@index([nodeId])
  @@index([timestamp])
  @@index([nodeId, timestamp])
}

// Network layout preset for saving/loading configurations
model NetworkLayout {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  // JSON blob containing the full network configuration
  layoutData  Json
  
  isDefault   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isDefault])
}

// System settings - singleton table for application configuration
// Stored in database instead of env vars for UI-based management
model SystemSettings {
  id                  String   @id @default("system")
  
  // Setup status
  isSetupComplete     Boolean  @default(false)
  
  // Authentication
  adminPasswordHash   String?  // bcrypt hash of admin password
  sessionSecret       String?  // Secret for JWT/session token generation
  
  // n8n Webhook Integration
  n8nWebhookUrl       String?  // Webhook endpoint for notifications
  n8nWebhookSecret    String?  // HMAC secret for webhook signing
  
  // Monitoring Settings
  probeTimeoutMs              Int     @default(5000)   // Timeout to mark probe offline
  statusHistoryRetentionDays  Int     @default(30)     // How long to keep status history
  internetCheckTargets        String  @default("8.8.8.8,1.1.1.1,208.67.222.222")  // IPs for internet checks
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}


